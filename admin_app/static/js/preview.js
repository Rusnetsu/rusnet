let currentMenuTree=[];let messageHistory=[];function initializePreview(menuTree){console.log('Initializing preview with menu data:',menuTree);currentMenuTree=menuTree||[];messageHistory=[];if(currentMenuTree.length===0){showEmptyDatabaseMessage();return;}document.getElementById('reset-preview').addEventListener('click',resetPreview);startConversation();}function showEmptyDatabaseMessage(){const container=document.getElementById('menu-container');container.innerHTML=`<div class="bot-message"><div style="text-align: center; color: #ff6b6b;"><div style="font-size: 48px; margin-bottom: 10px;">üì≠</div><strong>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞</strong><br>–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é.<br>–î–æ–±–∞–≤—å—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.</div></div>`;}function startConversation(){messageHistory=[];const totalItems=currentMenuTree.length;const rootItems=currentMenuTree.filter(item=>!item.parent_key).length;addBotMessage('üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –≠—Ç–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –º–µ–Ω—é –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞.',null,false);addBotMessage(`üìä <strong>–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:</strong><br>‚Ä¢ –í—Å–µ–≥–æ –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é: ${totalItems}<br>‚Ä¢ –ö–æ—Ä–Ω–µ–≤—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤: ${rootItems}<br>‚Ä¢ –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞: ${new Date().toLocaleString('ru-RU')}`,null,false);renderMenu(null);}function getItemsByParent(parentKey){return currentMenuTree.filter(item=>(item.parent_key||'')===(parentKey||'')).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));}function escapeHtml(unsafe){if(unsafe==null)return'';return String(unsafe).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}function getPathText(itemKey){const path=[];let current=itemKey;while(current){const item=currentMenuTree.find(i=>i.key===current);if(!item)break;path.unshift(item.title);current=item.parent_key||null;}return path.join(' ‚Üí ');}function createMenuButtonElement(item){const hasChildren=currentMenuTree.some(i=>i.parent_key===item.key);const button=document.createElement('button');button.className='menu-button';button.innerHTML=escapeHtml(item.title)+(hasChildren?' ‚Ä∫':'');button.dataset.key=item.key;button.dataset.hasChildren=hasChildren;button.onclick=()=>{const key=button.dataset.key;const isParent=button.dataset.hasChildren==='true';const targetItem=currentMenuTree.find(i=>i.key===key);if(!targetItem)return;if(isParent){addBotMessage(`–í—ã –≤—ã–±—Ä–∞–ª–∏: <strong>"${escapeHtml(targetItem.title)}"</strong>`,null,false);renderMenu(key);}else{showItemDetails(targetItem);}};return button;}function getActionText(action){const map={'none':'‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è','order':'üõí –ó–∞–∫–∞–∑–∞—Ç—å','download':'üì• –°–∫–∞—á–∞—Ç—å','pay':'üí≥ –û–ø–ª–∞—Ç–∏—Ç—å'};return map[action]||action;}function showItemDetails(item){addBotMessage(`–í—ã –≤—ã–±—Ä–∞–ª–∏: <strong>"${escapeHtml(item.title)}"</strong>`,null,false);const detailsContainer=document.createElement('div');detailsContainer.className='item-details';let detailsHTML=`<div class="detail-title">${escapeHtml(item.title)}</div>${item.description?`<div class="detail-description">${escapeHtml(item.description)}</div>`:''}${item.price?`<div class="detail-price">üí∞ ${escapeHtml(item.price)}</div>`:''}`;if(item.image_path){const imageUrl=`/admin_app/static/bots/bot_${currentBotId}/${item.image_path}`;detailsHTML+=`<div style="margin: 15px 0; text-align: center;"><img src="${imageUrl}" alt="${escapeHtml(item.title)}" onerror="console.error('Failed to load image:', this.src); this.style.display='none'" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid #2b5278;"></div>`;}if(item.file_path&&item.action==='download'){const filename=item.file_path.split('/').pop();const fileUrl=`/file/${currentBotId}/${filename}`;detailsHTML+=`<div style="margin: 15px 0; text-align: center;"><a href="${fileUrl}" download class="detail-action action-download" style="display: inline-block; padding: 12px 20px; text-decoration: none;">üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª: ${escapeHtml(filename)}</a></div>`;}if(item.action&&item.action!=='none'&&item.action!=='download'){detailsHTML+=`<div class="detail-action action-${item.action}">${getActionText(item.action)}</div>`;}detailsContainer.innerHTML=detailsHTML;const navContainer=document.createElement('div');navContainer.className='detail-navigation';navContainer.style.cssText='display: flex; gap: 10px; margin-top: 15px; justify-content: center;';const backBtn=document.createElement('button');backBtn.className='menu-button';backBtn.style.flex='1';backBtn.innerHTML='‚Üê –ù–∞–∑–∞–¥';backBtn.onclick=()=>{const newParentKey=item.parent_key||null;renderMenu(newParentKey);};const homeBtn=document.createElement('button');homeBtn.className='menu-button';homeBtn.style.flex='1';homeBtn.innerHTML='üîÑ –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é';homeBtn.onclick=()=>{renderMenu(null);};navContainer.appendChild(backBtn);navContainer.appendChild(homeBtn);detailsContainer.appendChild(navContainer);const container=document.getElementById('menu-container');container.appendChild(detailsContainer);container.scrollTop=container.scrollHeight;let actionMsg='‚ÑπÔ∏è –ù—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º!';if(item.action==='order'){actionMsg='üõí <strong>–ó–∞–∫–∞–∑ —É—Å–ª—É–≥–∏</strong><br>–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è. –°–ø–∞—Å–∏–±–æ –∑–∞ –≤—ã–±–æ—Ä!';}else if(item.action==='download'){actionMsg='üì• <strong>–°–∫–∞—á–∏–≤–∞–Ω–∏–µ</strong><br>–í—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫—É –≤—ã—à–µ.';}setTimeout(()=>addBotMessage(actionMsg,null,false),500);}function renderMenu(parentKey=null){const items=getItemsByParent(parentKey);let headerText='';if(parentKey){const parentItem=currentMenuTree.find(i=>i.key===parentKey);if(parentItem){headerText=`üìÅ <strong>${escapeHtml(parentItem.title)}</strong><br>–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é:`;const pathEl=document.createElement('div');pathEl.className='path-indicator';pathEl.innerHTML=`<strong>–¢–µ–∫—É—â–∏–π —Ä–∞–∑–¥–µ–ª:</strong> ${escapeHtml(getPathText(parentKey))}`;addBotMessage(headerText,[{isPath:true,element:pathEl}],false);}else{renderMenu(null);return;}}else{headerText='üè† <strong>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</strong><br>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:';addBotMessage(headerText,[],false);}const buttons=[];if(parentKey){const parentItem=currentMenuTree.find(i=>i.key===parentKey);const backBtn=document.createElement('button');backBtn.className='menu-button back-button';backBtn.innerHTML='‚Üê –ù–∞–∑–∞–¥';backBtn.onclick=()=>{const backParentKey=parentItem?parentItem.parent_key:null;renderMenu(backParentKey);};buttons.push({element:backBtn});}items.forEach(item=>{buttons.push({element:createMenuButtonElement(item)});});if(buttons.length>0){const container=document.getElementById('menu-container');const grid=document.createElement('div');grid.className='menu-buttons-container';buttons.forEach(btn=>{if(btn.isPath){}else{grid.appendChild(btn.element);}});container.appendChild(grid);container.scrollTop=container.scrollHeight;}}function addBotMessage(text,extraElements=null,showTyping=true){if(showTyping){showTypingIndicator();setTimeout(()=>{hideTypingIndicator();_addBotMessageInternal(text,extraElements);},800);}else{_addBotMessageInternal(text,extraElements);}}function _addBotMessageInternal(text,extraElements){const container=document.getElementById('menu-container');const msgDiv=document.createElement('div');msgDiv.className='bot-message';const time=new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});msgDiv.innerHTML=`${text}<div class="bot-message-time">${time}</div>`;container.appendChild(msgDiv);if(extraElements&&extraElements.length>0){extraElements.forEach(el=>{if(el.isPath){container.appendChild(el.element);}});}container.scrollTop=container.scrollHeight;}function showTypingIndicator(){const container=document.getElementById('menu-container');if(document.getElementById('typing-indicator'))return;const div=document.createElement('div');div.id='typing-indicator';div.className='typing-indicator';div.innerHTML=`<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>–ë–æ—Ç –ø–µ—á–∞—Ç–∞–µ—Ç...`;container.appendChild(div);}function hideTypingIndicator(){const el=document.getElementById('typing-indicator');if(el)el.remove();}function resetPreview(){messageHistory=[];startConversation();}window.initializePreview=initializePreview;window.resetPreview=resetPreview;