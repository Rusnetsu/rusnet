let selectedItems=new Set();let changedItems=new Set();let currentParentFilter='';let currentSearchQuery='';function markAsChanged(itemId){changedItems.add(itemId);const row=document.getElementById(`row-${itemId}`);if(row){row.style.backgroundColor='#fff3cd';}updateSelection();}function updateSelection(){const checkboxes=document.querySelectorAll('.item-checkbox:checked');selectedItems=new Set(Array.from(checkboxes).map(cb=>parseInt(cb.value)));const selectedCountElement=document.getElementById('selected-count');if(selectedCountElement){selectedCountElement.textContent=selectedItems.size;}const floatingActions=document.getElementById('floating-actions');if(floatingActions){if(selectedItems.size>0||changedItems.size>0){floatingActions.style.display='block';}else{floatingActions.style.display='none';}}}function toggleAllSelection(checked){document.querySelectorAll('.item-checkbox').forEach(checkbox=>{checkbox.checked=checked;});updateSelection();}function clearSelection(){document.querySelectorAll('.item-checkbox').forEach(checkbox=>{checkbox.checked=false;});selectedItems.clear();changedItems.clear();document.querySelectorAll('[id^="row-"]').forEach(row=>{row.style.backgroundColor='';});updateSelection();}async function saveSelected(){const itemsToSave=new Set([...selectedItems,...changedItems]);if(itemsToSave.size===0){showMessage('❌ Нет выбранных или измененных элементов','error');return;}const saveBtn=event.target;const originalText=saveBtn.textContent;saveBtn.disabled=true;saveBtn.textContent='Сохранение...';try{let successCount=0;let errorCount=0;for(const itemId of itemsToSave){try{await saveSingleItem(itemId,true);successCount++;}catch(err){errorCount++;console.error(`Ошибка сохранения элемента ${itemId}:`,err);}}if(errorCount===0){showMessage(`✅ Успешно сохранено ${successCount} элементов`,'success');clearSelection();}else{showMessage(`✅ Сохранено ${successCount}, ошибок: ${errorCount}`,'warning');}}catch(err){showMessage('❌ Ошибка при массовом сохранении','error');console.error('Mass save error:',err);}finally{saveBtn.disabled=false;saveBtn.textContent=originalText;}}async function saveSingleItem(itemId,silent=false){const form=document.querySelector(`form[data-id="${itemId}"]`);if(!form){if(!silent)showMessage('❌ Форма не найдена','error');return false;}const saveBtn=form.querySelector('.save-btn');const originalText=saveBtn.textContent;saveBtn.disabled=true;saveBtn.textContent='Сохранение...';const formData=new FormData(form);try{const response=await fetch('/admin/save',{method:'POST',body:formData,headers:{'Accept':'text/html'}});const result=await response.text();if(result==='OK'){changedItems.delete(itemId);const row=document.getElementById(`row-${itemId}`);if(row)row.style.backgroundColor='';if(!silent){showMessage('✅ Сохранено!','success');updateTable();}return true;}else{if(!silent){showMessage('❌ Ошибка сохранения: '+result,'error');}return false;}}catch(err){if(!silent){showMessage('⚠️ Нет связи с сервером','error');}console.error('Save failed:',err);return false;}finally{saveBtn.disabled=false;saveBtn.textContent=originalText;}}async function deleteSelected(){if(selectedItems.size===0){showMessage('❌ Нет выбранных элементов','error');return;}if(!confirm(`Вы уверены, что хотите удалить ${selectedItems.size} элементов? Это действие нельзя отменить.`)){return;}const deleteBtn=event.target;const originalText=deleteBtn.textContent;deleteBtn.disabled=true;deleteBtn.textContent='Удаление...';try{let successCount=0;let errorCount=0;for(const itemId of selectedItems){try{await deleteSingleItem(itemId,true);successCount++;}catch(err){errorCount++;console.error(`Ошибка удаления элемента ${itemId}:`,err);}}if(errorCount===0){showMessage(`✅ Успешно удалено ${successCount} элементов`,'success');updateTable();clearSelection();}else{showMessage(`✅ Удалено ${successCount}, ошибок: ${errorCount}`,'warning');}}catch(err){showMessage('❌ Ошибка при массовом удалении','error');console.error('Mass delete error:',err);}finally{deleteBtn.disabled=false;deleteBtn.textContent=originalText;}}function updateFileInfo(form,response){if(response.image_path){const imageContainer=form.querySelector('.image-info');if(!imageContainer){const fileInput=form.querySelector('input[name="image"]');const newImageInfo=document.createElement('div');newImageInfo.className='image-info';newImageInfo.style.marginTop='8px';newImageInfo.innerHTML=`<small>Текущее: ${response.image_path}</small><br><label><input type="checkbox" name="remove_image" value="1"> Удалить изображение</label>`;fileInput.parentNode.appendChild(newImageInfo);}else{imageContainer.querySelector('small').textContent=`Текущее: ${response.image_path}`;}}if(response.file_path){const fileContainer=form.querySelector('.file-info');if(!fileContainer){const fileInput=form.querySelector('input[name="file"]');const newFileInfo=document.createElement('div');newFileInfo.className='file-info';newFileInfo.style.marginTop='8px';newFileInfo.innerHTML=`<small>Текущее: ${response.file_path}</small><br><label><input type="checkbox" name="remove_file" value="1"> Удалить файл</label>`;fileInput.parentNode.appendChild(newFileInfo);}else{fileContainer.querySelector('small').textContent=`Текущее: ${response.file_path}`;}}}async function deleteSingleItem(id,silent=false){if(!silent&&!confirm('Вы уверены, что хотите удалить этот пункт? Это действие нельзя отменить.')){return;}const deleteBtn=event?.target||document.querySelector(`button[onclick="deleteSingleItem(${id})"]`);const originalText=deleteBtn?.textContent;if(deleteBtn){deleteBtn.disabled=true;deleteBtn.textContent='Удаление...';}try{const response=await fetch('/admin/delete',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({id:id})});if(response.ok){selectedItems.delete(id);changedItems.delete(id);if(!silent){showMessage('✅ Удалено!','success');updateTable();}return true;}else{if(!silent){showMessage('❌ Ошибка удаления','error');}return false;}}catch(err){if(!silent){showMessage('⚠️ Ошибка соединения с сервером','error');}console.error('Delete failed:',err);return false;}finally{if(deleteBtn){deleteBtn.disabled=false;deleteBtn.textContent=originalText;}}}function showMessage(text,type){const msgDiv=document.getElementById('message');if(!msgDiv)return;msgDiv.className=`message ${type}`;msgDiv.innerHTML=text;setTimeout(()=>{msgDiv.innerHTML='';msgDiv.className='';},5000);}async function updateTable(){try{let url='/admin/table';const params=new URLSearchParams();if(currentParentFilter){params.append('parent_filter',currentParentFilter);}if(currentSearchQuery){params.append('search_query',currentSearchQuery);}const queryString=params.toString();if(queryString){url+='?'+queryString;}const response=await fetch(url);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}const tableHtml=await response.text();const itemsTable=document.getElementById('items-table');if(itemsTable){itemsTable.innerHTML=tableHtml;}updateFilterInfo();rebindEvents();}catch(err){showMessage('⚠️ Ошибка обновления таблицы: '+err.message,'error');console.error('Table update failed:',err);}}function applyFilters(){const parentFilter=document.getElementById('parent-filter');const searchInput=document.getElementById('search-input');if(parentFilter)currentParentFilter=parentFilter.value;if(searchInput)currentSearchQuery=searchInput.value.trim();updateTable();}function clearFilters(){const parentFilter=document.getElementById('parent-filter');const searchInput=document.getElementById('search-input');if(parentFilter)parentFilter.value='';if(searchInput)searchInput.value='';currentParentFilter='';currentSearchQuery='';updateTable();}function updateFilterInfo(){const infoDiv=document.getElementById('filter-info');if(!infoDiv)return;let infoText='';if(currentParentFilter||currentSearchQuery){infoText='Применены фильтры: ';const filters=[];if(currentParentFilter){const selectedOption=document.getElementById('parent-filter')?.selectedOptions[0];if(selectedOption){filters.push(`раздел: "${selectedOption.text}"`);}}if(currentSearchQuery){filters.push(`поиск: "${currentSearchQuery}"`);}infoText+=filters.join(', ');}else{infoText='Все элементы отображаются';}infoDiv.textContent=infoText;}async function handleSubmit(form,event){event.preventDefault();const submitBtn=form.querySelector('button[type="submit"]');const originalText=submitBtn.textContent;submitBtn.disabled=true;submitBtn.textContent='Сохранение...';const formData=new FormData(form);let url;if(form.id==='add-form'){url='/admin/add';}else if(form.classList.contains('edit-form')){url='/admin/save';}else{return;}try{const response=await fetch(url,{method:'POST',body:formData,headers:{'Accept':'text/html'}});if(response.ok){showMessage('✅ Сохранено!','success');updateTable();if(form.id==='add-form'){form.reset();const select=form.querySelector('[name="action"]');if(select)select.value='none';}}else{showMessage('❌ Ошибка сохранения','error');}}catch(err){showMessage('⚠️ Нет связи с сервером','error');console.error('Request failed:',err);}finally{submitBtn.disabled=false;submitBtn.textContent=originalText;}}function rebindEvents(){document.querySelectorAll('.edit-form').forEach(form=>{form.addEventListener('submit',(e)=>handleSubmit(form,e));});document.querySelectorAll('button[onclick*="deleteItem"]').forEach(btn=>{const oldOnClick=btn.getAttribute('onclick');const match=oldOnClick.match(/deleteItem\((\d+)\)/);if(match){const id=match[1];btn.removeAttribute('onclick');btn.addEventListener('click',()=>deleteSingleItem(id));}});document.querySelectorAll('input, textarea, select').forEach(element=>{const form=element.closest('form');if(form&&form.dataset.id){const itemId=parseInt(form.dataset.id);element.addEventListener('input',()=>markAsChanged(itemId));element.addEventListener('change',()=>markAsChanged(itemId));}});const parentFilter=document.getElementById('parent-filter');const searchInput=document.getElementById('search-input');if(parentFilter){parentFilter.addEventListener('change',applyFilters);}if(searchInput){searchInput.addEventListener('input',function(){clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(applyFilters,500);});}}document.addEventListener('DOMContentLoaded',function(){rebindEvents();updateFilterInfo();const addForm=document.getElementById('add-form');if(addForm){addForm.addEventListener('submit',function(e){handleSubmit(addForm,e);});}const parentFilter=document.getElementById('parent-filter');const searchInput=document.getElementById('search-input');if(parentFilter){parentFilter.addEventListener('change',applyFilters);}if(searchInput){searchInput.addEventListener('input',function(){clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(applyFilters,500);});}});